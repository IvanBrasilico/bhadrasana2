{% extends "layout.html" %} {% block content %} {{super()}}
<div id="main" class="container-fluid">
    <div id="top" class="row">
        <div class="col-sm-12">
            <form method="POST" id="formrvf" action="rvf">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="id" value="{{ oform.id.data }}"/>
                <div class="row">
                    <div class="form-group">
                        <div class="col-sm-3">
                            CE Mercante
                            {{ oform.numeroCEmercante(class='form-control')}}
                        </div>
                        <div class="col-sm-3">
                            Peso verificado em Kg
                            {{ oform.peso(class='form-control')}}
                        </div>
                        <div class="col-sm-3">
                            Volume verificado em m3
                            {{ oform.volume(class='form-control')}}
                        </div>
                        <div class="col-sm-3">
                        </div>
                        <div class="col-sm-12">
                            Descrição
                            {{ oform.descricao(class='form-control') }}
                        </div>
                        <div class="col-sm-12">
                            <div class="col-sm-3">
                                <label for="data">Dia da verificação</label>
                            </div>
                            <div class="col-sm-3">
                                <label for="data">Hora da verificação</label>
                            </div>
                        </div>
                        <div class="col-sm-12">
                            <div class="col-sm-3">
                                {{ oform.adata(class='form-control') }}
                            </div>
                            <div class="col-sm-3">
                                {{ oform.ahora(class='form-control') }}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row col-sm-12">
                    &nbsp;<br>
                    <div class="col-sm-2">
                        <button class="btn btn-default btn-primary form-control" onclick="submit">
                            Salvar
                        </button>
                    </div>
                    <div class="col-sm-1">
                    </div>
                    <div class="col-sm-2">
                        <a href="rvf_impressao/{{ oform.id.data }}" class="btn btn-info form-control">
                            Imprimir
                        </a>
                    </div>
                    <div class="col-sm-7">
                    </div>
                </div>
            </form>
        </div>
        <div class="row col-sm-12">
            <div class="col-sm-3">
                <h3>Possíveis infrações detectadas</h3>
            </div>
            <div class="col-sm-9">
                <br>
                <div class="ui-widget">
                    <input id="infracoes" class="form-control">
                </div>
            </div>
        </div>
        <div class="row col-sm-12">
            <div class="col-sm-12" id="div_infracoes_encontradas" border="1">
                {% for infracao in infracoes_encontradas %}
                <button type="button" class="btn btn-primary">
                    {{ infracao.nome }} <span class="badge"
                                              onclick="exclui_infracao_encontrada({{oform.id.data}}, {{ infracao.id }})">X</span>
                </button>
                {% endfor %}
            </div>
        </div>
        <div class="row col-sm-12">
            <div class="col-sm-3">
                <h3>Marcas encontradas</h3>
            </div>
            <div class="col-sm-9">
                <br>
                <div class="ui-widget">
                    <input id="marcas" class="form-control">
                </div>
            </div>
        </div>
        <div class="row col-sm-12">
            <div class="col-sm-12" id="div_marcas_encontradas" border="1">
                {% for marca in marcas_encontradas %}
                <button type="button" class="btn btn-primary">
                    {{ marca.nome }} <span class="badge"
                                           onclick="exclui_marca_encontrada({{oform.id.data}}, {{ marca.id }})">X</span>
                </button>
                {% endfor %}
            </div>
        </div>
        <div class="row col-sm-12">
            <div class="form-group">
                <form action="rvf_imgupload" enctype="multipart/form-data" method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="rvf_id" value="{{ oform.id.data }}"/>
                    <h4>Selecione anexos:</h4>
                    <div class="col-sm-3"><input type="file" class="btn btn-default" name="images" multiple="">
                    </div>
                    <div class="col-sm-1">
                    </div>
                    <div class="col-sm-2">
                        <button class="btn btn-default btn-primary form-control" onclick="upload()">Enviar</button>
                    </div>
                    <div class="col-sm-6">
                    </div>
                </form>
            </div>
            <div class="row ">
                <div class="col-sm-12" id="div_imagens" border="1">
                    {% for anexo in anexos %}
                    <span class="badge">
                    <img src="image/{{anexo}}" class="btn btn-primary" alt="{{ anexo }}" width="240px" height="160px"/>
                    <span class="badge" onclick="exclui_anexo('{{ anexo }}')">X</span>
                    </span>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
<div id="bottom" class="row">
    AJNA - Receita Federal do Brasil 2017
</div>
</div>
{% endblock %} {% block scripts %} {{super()}}
<script>
    function mostra_infracoes(infracoes_encontradas){
        $('#div_infracoes_encontradas').empty();
        $.each(infracoes_encontradas, function(i, infracao) {
            $('<button type="button" class="btn btn-primary">').text(infracao.nome+ ' ').append(
            $('<span class="badge" onclick="exclui_infracao_encontrada({{oform.id.data}}, ' + infracao.id + ')">').text('X')
            ).appendTo('#div_infracoes_encontradas');
        });
    }
    function exclui_infracao_encontrada(rvf_id, infracao_id){
        $.getJSON('exclui_infracao_encontrada', {
          rvf_id: rvf_id, infracao_id: infracao_id
        }, function(infracoes_encontradas) {
          mostra_infracoes(infracoes_encontradas);
        });
    }
    function inclui_infracao_encontrada(rvf_id, infracao_nome){
        $.getJSON('inclui_infracao_encontrada', {
          rvf_id: rvf_id, infracao_nome: infracao_nome
        }, function(infracoes_encontradas) {
          mostra_infracoes(infracoes_encontradas);
        });
    }
    $( function() {
        var infracoes = [
        {% for infracao in infracoes %}
        "{{ infracao.nome }}",
        {% endfor %}
        ];
        $( "#infracoes" ).autocomplete({

          source: infracoes,

          select: function(event, ui){
            var newTag = $(this).val();
            $(this).val("");
            event.preventDefault();
          }
        });
    } );
    $('input#infracoes').bind('keydown', function(e) {
      if (e.keyCode == 13) {
        inclui_infracao_encontrada({{oform.id.data}}, $('input#infracoes').val());
      }
    });

    function mostra_marcas(marcas_encontradas){
        $('#div_marcas_encontradas').empty();
        $.each(marcas_encontradas, function(i, marca) {
            $('<button type="button" class="btn btn-primary">').text(marca.nome+ ' ').append(
            $('<span class="badge" onclick="exclui_marca_encontrada({{oform.id.data}}, ' + marca.id + ')">').text('X')
            ).appendTo('#div_marcas_encontradas');
        });
    }
    function exclui_marca_encontrada(rvf_id, marca_id){
        $.getJSON('exclui_marca_encontrada', {
          rvf_id: rvf_id, marca_id: marca_id
        }, function(marcas_encontradas) {
          mostra_marcas(marcas_encontradas);
        });
    }
    function inclui_marca_encontrada(rvf_id, marca_nome){
        $.getJSON('inclui_marca_encontrada', {
          rvf_id: rvf_id, marca_nome: marca_nome
        }, function(marcas_encontradas) {
          mostra_marcas(marcas_encontradas);
        });
    }
    $( function() {
        var marcas = [
        {% for marca in marcas %}
        "{{ marca.nome }}",
        {% endfor %}
        ];
        $( "#marcas" ).autocomplete({
          source: marcas,

          select: function(event, ui){
            var newTag = $(this).val();
            $(this).val("");
            event.preventDefault();
          }
        });
    } );
    $('input#marcas').bind('keydown', function(e) {
      if (e.keyCode == 13) {
        inclui_marca_encontrada({{oform.id.data}}, $('input#marcas').val());
        $('input#marcas').val('');
      }
    });

    function exclui_anexo(anexo_id){
        $.getJSON('exclui_anexo', {
         _id: anexo_id
        }, function(anexos) {
          // mostra_anexos(anexos);
        });
        location.reload();
    }
    function upload_files(){
    // Resize images before upload if images are too big
        var dataurl = null;
        // Create an image
        var img = document.createElement("img");
        // Create a file reader
        var reader = new FileReader();
        // Set the image once loaded into file reader
        reader.onload = function(e)
        {
            img.src = e.target.result;
            img.onload = function () {
                var canvas = document.createElement("canvas");
                var ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);
                var MAX_WIDTH = 800;
                var MAX_HEIGHT = 600;

                var width = img.width;
                var height = img.height;

                if (width > height) {
                  if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                  }
                } else {
                  if (height > MAX_HEIGHT) {
                    width *= MAX_HEIGHT / height;
                    height = MAX_HEIGHT;
                  }
                }
                canvas.width = width;
                canvas.height = height;
                var ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, width, height);
                dataurl = canvas.toDataURL("image/jpeg");
                // Post the data
                var fd = new FormData();
                fd.append("name", e.target);
                fd.append("image", dataurl);
                fd.append("rvf_id",  {{ rvf_id }});
                $.ajax({
                    url: '/rvf_imgupload',
                    data: fd,
                    cache: false,
                    contentType: false,
                    processData: false,
                    type: 'POST',
                    success: function(data){
                    }
                });
            }
            img.onload
        }
        // Load files into file reader

        var filesToUpload = $('input#images').files;
        for (file in filesToUpload[0]) {
            reader.readAsDataURL(file);
        }

    }












</script> {% endblock %}